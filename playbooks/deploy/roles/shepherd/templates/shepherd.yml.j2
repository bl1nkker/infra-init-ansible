version: '3.8'

networks:
  notification:

services:
  service:
    image: "{{ docker_registry }}containrrr/shepherd"
    environment:
      SLEEP_TIME: "10m"
      TZ: "Asia/Almaty"
      APPRISE_SIDECAR_URL: notify:5000
      VERBOSE: "true"
      FILTER_SERVICES: "label=shepherd.autodeploy=true"
      WITH_REGISTRY_AUTH: "true"
      IMAGE_AUTOCLEAN_LIMIT: "3"
      ROLLBACK_ON_FAILURE: "true"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /etc/docker:/etc/docker:ro
      - {{ docker_registry_config_path }}:/root/.docker/config.json:ro
    networks:
      - notification
    deploy:
      placement:
        constraints:
          - node.role == manager
  notify:
      image: "{{ docker_registry }}mazzolino/apprise-microservice:latest"
      environment:
        NOTIFICATION_URLS: mailto:///{{ email_notification_url }}
      networks:
        - notification
      deploy:
        labels:
          - "io.portainer.accesscontrol.public"
